/* Choice of best parameters for stage 2.

  Copyright 2001, 2002, 2003 Paul Zimmermann and Alexander Kruppa.

  This program is free software; you can redistribute it and/or modify it
  under the terms of the GNU General Public License as published by the
  Free Software Foundation; either version 2 of the License, or (at your
  option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT
  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
  more details.

  You should have received a copy of the GNU General Public License along
  with this program; see the file COPYING.  If not, write to the Free
  Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
  02111-1307, USA.
*/

#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include "gmp.h"
#include "ecm.h"

/* returns Euler's totient phi function */
unsigned long
phi (unsigned long n)
{
  unsigned long phi = 1, p;

  for (p = 2; p * p <= n; p += 2)
    {
      if (n % p == 0)
	{
	  phi *= p - 1;
	  n /= p;
	  while (n % p == 0)
	    {
	      phi *= p;
	      n /= p;
	    }
	}

      if (p == 2)
	p--;
    }

  /* now n is prime */

  return (n == 1) ? phi : phi * (n - 1);
}

/* return the maximal block size corresponding to d */
double block_size (unsigned long d)
{
  return (double) d * ((double) phi (d) / 2.0);
}

/*
  Return (d,k) such that:
  (0) k >= k0
  (1) d is a multiple of 6
  (2) k * d * (phi(d)/2) >= B2
  (3) the cost of step 2 is minimal
 */
unsigned long
bestD (double B2, unsigned int k0, unsigned int *k, double S, int method)
{
/* the following list contains successive values of (d,a,b) with
   increasing values of a and decreasing values of b/(d*phi(d)/2)
   where the cost of step2 is a + b * ceil(B2 / (d*phi(d)/2)).
*/
#define N 154  
  static double l[N][3] = {{12.0,-3.0,7.0}, {18.0,1.0,15.0}, {30.0,5.0,23.0}, {60.0,35.0,77.0}, {90.0,117.0,139.0}, {120.0,188.0,199.0}, {210.0,388.0,421.0}, {240.0,593.0,597.0}, {270.0,919.0,743.0}, {330.0,1126.0,917.0}, {420.0,1407.0,1055.0}, {510.0,2092.0,1491.0}, {840.0,3978.0,3093.0}, {1020.0,5847.0,4357.0}, {1260.0,8707.0,5443.0}, {1470.0,12096.0,7047.0}, {1680.0,12703.0,7659.0}, {1890.0,16844.0,9627.0}, {2040.0,18428.0,10775.0}, {2310.0,18642.0,10435.0}, {3570.0,34168.0,22181.0}, {3990.0,45873.0,26957.0}, {4080.0,49289.0,31157.0}, {4620.0,49599.0,30085.0}, {5460.0,71841.0,38943.0}, {6090.0,97012.0,50035.0}, {7140.0,102975.0,54655.0}, {8190.0,132840.0,68127.0}, {9240.0,146826.0,73991.0}, {14280.0,270082.0,157333.0}, {16170.0,351807.0,186881.0}, {16380.0,352515.0,190157.0}, {18480.0,382001.0,212469.0}, {19110.0,403213.0,220949.0}, {21840.0,555151.0,275843.0}, {24570.0,704986.0,342979.0}, {24990.0,734748.0,352943.0}, {25410.0,746233.0,351819.0}, {28560.0,788439.0,386699.0}, {30030.0,795910.0,374035.0}, {32760.0,995800.0,479787.0}, {34650.0,1068200.0,502087.0}, {39270.0,1101874.0,521667.0}, {60060.0,2036343.0,1078729.0}, {66990.0,2595169.0,1311769.0}, {67830.0,2605713.0,1336877.0}, {71610.0,2738705.0,1443217.0}, {78540.0,2831127.0,1494725.0}, {79170.0,2975323.0,1552165.0}, {90090.0,4006198.0,1875141.0}, {92820.0,4131733.0,1943743.0}, {103740.0,5165368.0,2408287.0}, {103530.0,5391828.0,2481267.0}, {106260.0,5440707.0,2467239.0}, {106470.0,5630113.0,2569011.0}, {108570.0,5670531.0,2555399.0}, {120120.0,5812914.0,2627375.0}, {131670.0,7081854.0,3238755.0}, {133980.0,7183348.0,3329403.0}, {139230.0,7259408.0,3370047.0}, {150150.0,7798444.0,3524515.0}, {157080.0,8045442.0,3666535.0}, {158340.0,8432626.0,3806111.0}, {240240.0,14756185.0,7569321.0}, {237510.0,15412045.0,7794105.0}, {237930.0,15447757.0,7829097.0}, {270270.0,18323097.0,9034385.0}, {274890.0,18715903.0,9197025.0}, {278460.0,18842859.0,9381197.0}, {300300.0,19830079.0,10122313.0}, {314160.0,20518713.0,10492789.0}, {324870.0,21478341.0,10887189.0}, {330330.0,21675041.0,10822677.0}, {371280.0,30053475.0,13657443.0}, {420420.0,36897246.0,16693213.0}, {417690.0,37136350.0,16887619.0}, {431970.0,38960525.0,17288139.0}, {450450.0,39946331.0,17696971.0}, {510510.0,41732214.0,18428019.0}, {570570.0,50621702.0,22680823.0}, {565110.0,55607014.0,24580779.0}, {600600.0,55944984.0,24711175.0}, {628320.0,57792330.0,25725155.0}, {649740.0,60370250.0,26686827.0}, {690690.0,60685330.0,26549571.0}, {1021020.0,105452791.0,53057993.0}, {1141140.0,130322031.0,63260617.0}, {1138830.0,133285593.0,64437977.0}, {1231230.0,141593193.0,70935313.0}, {1256640.0,146724671.0,73568325.0}, {1291290.0,149335760.0,73388297.0}, {1345890.0,153111427.0,76298405.0}, {1381380.0,153786855.0,75776933.0}, {1711710.0,250069290.0,112437011.0}, {1741740.0,262258994.0,116929077.0}, {1763580.0,264094540.0,118331647.0}, {1806420.0,276250207.0,121086279.0}, {1861860.0,282684031.0,123887735.0}, {1845690.0,286332907.0,125286343.0}, {2042040.0,296597122.0,129141583.0}, {2072070.0,307940833.0,132798571.0}, {2282280.0,358399790.0,158805155.0}, {2277660.0,364434556.0,163464731.0}, {2312310.0,386250594.0,169199931.0}, {2316930.0,387141695.0,169734523.0}, {2372370.0,392323764.0,171031479.0}, {2386020.0,393504422.0,172083903.0}, {2552550.0,397325444.0,173136451.0}, {2513280.0,411024346.0,180313671.0}, {2612610.0,416516943.0,179639411.0}, {2645370.0,425281073.0,184269259.0}, {2691780.0,428276554.0,186983935.0}, {2762760.0,428804418.0,185883367.0}, {2732730.0,429545650.0,188136775.0}, {2852850.0,435974520.0,187944611.0}, {4084080.0,747417465.0,371696809.0}, {4037670.0,776338029.0,382356409.0}, {4144140.0,777916948.0,379187797.0}, {4114110.0,779912061.0,383925289.0}, {4594590.0,920199209.0,442903953.0}, {4555320.0,942394423.0,451301281.0}, {4654650.0,959479082.0,458278913.0}, {4834830.0,985189145.0,476394617.0}, {5105100.0,1002859751.0,496863625.0}, {5135130.0,1021821988.0,500855161.0}, {5026560.0,1040610177.0,515453429.0}, {5225220.0,1051315138.0,513672737.0}, {5290740.0,1075170340.0,525986497.0}, {5383560.0,1083466957.0,534441109.0}, {5615610.0,1084288713.0,530511253.0}, {5705700.0,1101156331.0,536720577.0}, {7147140.0,1851985122.0,818809757.0}, {7054320.0,1866119794.0,828794659.0}, {7087080.0,1930122799.0,838167751.0}, {7225680.0,1947950601.0,847880619.0}, {7417410.0,1957424048.0,846661799.0}, {7657650.0,1990139467.0,867249771.0}, {7537530.0,2028334023.0,883959419.0}, {7987980.0,2093646804.0,899027735.0}, {8168160.0,2095286022.0,904572755.0}, {8288280.0,2163351057.0,929322023.0}, {8198190.0,2168784146.0,941343827.0}, {8678670.0,2174660266.0,940554515.0}, {9699690.0,2524388166.0,1111794903.0}, {9669660.0,2717624410.0,1184196063.0}, {9606870.0,2770487838.0,1204661067.0}, {9639630.0,2778680715.0,1206732879.0}, {10210200.0,2805269008.0,1212588007.0}, {10270260.0,2852352341.0,1220768551.0}, {10360350.0,2883901809.0,1247654207.0}, {10330320.0,2926646959.0,1257385271.0}, {10307220.0,3016724202.0,1301328995.0}, {10292100.0,3035639002.0,1317488003.0}, {10341870.0,3065584131.0,1318417379.0}};

  unsigned int i;
  unsigned long d, dmin, dF;
  double j, cost, mincost = 10.0 * B2, a, b;

  if (S < 0)
    S = -S;

  if (method == EC_METHOD)
    S = 6.0 * S; /* cost per group addition */

  S = 2.5 * S; /* overhead for real modular multiplies */

  for (i = 0; i < N && l[i][1] < mincost; i++)
    {
      d = (unsigned long) l[i][0];
      dF = phi (d) / 2.0;
      j = ceil (B2 / (double) d / (double) dF);
      a = l[i][1] + (double) (d / 6)  * (double) S;
      b = l[i][2] + (double) dF * (double) S;
      cost = a + j * b;
      if (j >= k0 && cost < mincost)
        {
          mincost = cost;
          dmin = d;
          *k = (unsigned int) j;
        }
    }

  if (mincost == 10.0 * B2)
    {
      fprintf (stderr, "Error, too large step2 range, please increase k\n");
      exit (1);
    }

  return dmin;

}
